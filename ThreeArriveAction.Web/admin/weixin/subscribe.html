<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>关注时回复</title>
    <link href="../skin/default/style.css" rel="stylesheet" type="text/css" />
    <link href="../skin/mystyle.css" rel="stylesheet" type="text/css" />
</head>

<body class="mainbody">
    <form id="form1">
        <!--导航栏-->
        <div class="location" style="display:none;">
            <a href="javascript:;" class="home">
                <i></i><span>
                <label id="postion"></label>
                </span>
            </a>
        </div>
        <div class="line10"></div>
        <!--/导航栏-->
        <!--内容-->
        <input type="hidden" id="hidId" value="0" />
        <label id="lblact" style="display:none;"></label>
        <label id="lblreqestType" style="display:none;"></label>
        <div class="content-tab-wrap">
            <div id="floatHead" class="content-tab">
                <div class="content-tab-ul-wrap">
                    <ul>
                        <li><a href="javascript:;" onclick="tabs(this);" class="selected"><label id="postion2"></label></a></li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="tab-content">
            <div class="mytips">
                只能选择其一！
            </div>
            <dl>
                <dt>类型</dt>
                <dd>
                    <div class="rule-multi-radio">
                        <input type="radio" id="rblResponseType_0" name="rblResponseType" value="0" /><label for="rblResponseType_0">文本</label>
                        <input type="radio" id="rblResponseType_1" name="rblResponseType" value="1" /><label for="rblResponseType_1">图文</label>
                        <input type="radio" id="rblResponseType_2" name="rblResponseType" value="2" /><label for="rblResponseType_2">语音</label>
                    </div>
                </dd>
            </dl>

            <dl class="wenben" style="display: none;">
                <dt>内容</dt>
                <dd>
                    <textarea id="txtContent" class="input" style="height:300px;" datatype="*0-1000" sucmsg="*最多1000个字符"></textarea>
                    <span class="Validform_checktip">*最多1000个字符</span>
                </dd>
            </dl>
            <dl id="div_music_title" style="display: none;" class="music">
                <dt>音乐标题</dt>
                <dd>
                    <input type="text" id="txtMusicTitle" class="input normal" datatype="*0-255" sucmsg="最多30个字符" />
                    <span class="Validform_checktip">*最多30个字符</span>
                </dd>
            </dl>

            <dl id="div_music_url" style="display: none;" class="music">
                <dt>音乐链接</dt>
                <dd>
                    <input type="text" id="txtMusicUrl" class="input normal upload-path" />
                    <div class="upload-box upload-img"></div>
                    <span class="Validform_checktip">*支持mp3格式，可以填写网上的链接，也可以本地上传！</span>
                </dd>
            </dl>
            <dl id="div_music_remark" style="display: none;" class="music">
                <dt>音乐描述</dt>
                <dd>
                    <input type="text" id="txtMusicRemark" class="input normal upload-path" />
                </dd>
            </dl>

            <dl class="picnews" style="display: none;">
                <dt></dt>
                <dd>
                    <a id="itemAddButton" class="icon-btn add"><i></i><span>添加内容</span></a>
                    <span class="Validform_checktip"></span>
                </dd>
            </dl>

            <dl class="picnews" style="display: none;">
                <dt></dt>
                <dd>
                    <table border="0" cellspacing="0" cellpadding="0" class="border-table" width="98%">
                        <thead>
                            <tr>
                                <th width="20%">图片</th>
                                <th width="40%">标题</th>
                                <th width="25%">链接</th>
                                <th width="5%">排序</th>
                                <th width="10%">操作</th>
                            </tr>
                        </thead>
                        <tbody id="var_box">
                            
                        </tbody>
                    </table>
                </dd>
            </dl>
        </div><!--/内容-->
        <!--工具栏-->
        <div class="page-footer" id="div_gongju">
            <div class="btn-list">
                <button type="submit" id="btnSubmit" class="btn">提交保存</button>
            </div>
            <div class="clear"></div>
        </div>
        <!--/工具栏-->
    </form>
    <script type="text/javascript" src="../../scripts/jquery/jquery-1.10.2.min.js"></script>
    <script type="text/javascript" src="../../scripts/jquery/Validform_v5.3.2_min.js"></script>
    <script type="text/javascript" src="../../scripts/lhgdialog/lhgdialog.js?skin=idialog"></script>
    <script type="text/javascript" src="../../scripts/datepicker/WdatePicker.js"></script>
    <script type="text/javascript" src="../../scripts/swfupload/swfupload.js"></script>
    <script type="text/javascript" src="../../scripts/swfupload/swfupload.queue.js"></script>
    <script type="text/javascript" src="../../scripts/swfupload/swfupload.handlers.js"></script>
    <script type="text/javascript" charset="utf-8" src="../../editor/kindeditor-min.js"></script>
    <script type="text/javascript" charset="utf-8" src="../../editor/lang/zh_CN.js"></script>
    <script type="text/javascript" src="../js/layout.js"></script>

    <script type="text/javascript">
        $(function () {
            //获取url路径
            var url = window.location.href;
            var urlStr = url.substring(url.indexOf('?') + 1)
            $("#lblact").text(urlStr.split('=')[1]);
            $.getJSON('../../Ajax/wxrequestRulesManager.ashx?type=search&' + urlStr, function (msg) {
                if (msg) {
                    //console.info("ces");
                    $("#postion").text(msg.reqestText);
                    $("#postion2").text(msg.reqestText);
                    $("input[name='rblResponseType']:checked").val(msg.responseType);
                    $("#lblreqestType").text(msg.reqestType);
                    $("#hidId").val(msg.rId);
                    if (msg.responseType == 0) {
                        $("#txtContent").val(msg.txtContent);
                        $(".wenben").show();
                    } else if (msg.responseType == 1) {
                        if (msg.rows.length > 0) {
                            $("#var_box").html("");
                            for (var i = 0; i < msg.rows.length; i++) {
                                var str = "<tr>";
                                str += "<td><img id='img" + i + "' width='50px' height='50px' stryle='max-height:50px;max-width:100px; width:50px;height:50px;' src='" + msg.rows[i].picUrl + "' /></td>";
                                str += "<td>" + msg.rows[i].rContent + "</td>";
                                str += "<td>" + msg.rows[i].detailUrl + "</td>";
                                str += "<td>" + msg.rows[i].seq + "</td>";
                                str += "<td><a title='编辑' href='javascript:showGuiZeDialog("+msg.rows[i].id+")'>编辑</a>&nbsp;&nbsp;<a title='删除' href='javascript:Delete("+msg.rows[i].id+")'>删除</a></td>";
                                str += "</tr>";
                                $("#var_box").append(str);
                            }
                        }
                        $(".picnews").show();
                        $("#div_gongju").hide();
                    } else {
                        $("#txtMusicTitle").val(msg.musicTitle);
                        $("#txtMusicUrl").val(msg.musicFile);
                        $("#txtMusicRemark").val(msg.musicRemark);
                        $(".music").show();
                    }
                }
            });
           
            //初始化上传控件
            $(".upload-img").each(function () {
                $(this).InitSWFUpload({ sendurl: "../../Ajax/upload_ajax.ashx", flashurl: "../../scripts/swfupload/swfupload.swf", filetypes: "*.jpg;*.jpge;*.png;*.gif;*.rar;*.zip;*.doc;*.xls;*.mp3;*.mp4" });
            });

            $("input[name='rblResponseType']").click(function () {
                console.info($(this).val());
                if ($(this).val() == "0") {
                    //文本
                    $(".wenben").show();
                    $(".music").hide();
                    $(".picnews").hide();
                    $("#div_gongju").show();
                }
                else if ($(this).val() == "1") {
                    //图文
                    $(".picnews").show();
                    $(".music").hide();
                    $(".wenben").hide();
                    $("#div_gongju").hide();

                }
                else if ($(this).val() == "2") {
                    //语音
                    $(".wenben").hide();
                    $(".music").show();
                    $(".picnews").hide();
                    $("#div_gongju").show();
                }

            });
            //初始化表单验证
            $("#form1").initValidform();
            $("#btnSubmit").click(function () {
                var rType = $("input[name='rblResponseType']:checked").val();

                if (rType == "0") {
                    var txtContent = $("#txtContent").val();

                    if ($.trim(txtContent) == "") {
                        $.dialog.alert("请填写内容");
                        return false;
                    }

                }
                if (rType == "2") {
                    var txtMusicTitle = $("#txtMusicTitle").val();
                    var txtMusicFile = $("#txtMusicFile").val();

                    if ($.trim(txtMusicTitle) == "") {
                        $.dialog.alert("请填写音乐标题");
                        return false;
                    }

                    if ($.trim(txtMusicFile) == "") {
                        $.dialog.alert("请填写音乐链接");
                        return false;
                    }

                }
                var data = {
                    requestType: $("#lblreqestType").text(),
                    txtContent: $("#txtContent").val(),
                    txtMusicTitle : $("#txtMusicTitle").val(),
                    txtMusicFile :$("#txtMusicFile").val(),
                    txtMusicRemark: $("#txtMusicRemark").val(),
                    rId: $("#hidId").val(),
                    responseType:$("input[name='rblResponseType']:checked").val()

                };
                $.post('../../Ajax/wxrequestRulesManager.ashx?type=save',data, function (msg) {
                    var result = $.parseJSON(msg);
                    if (reg.status == "y") {
                        alert(reg.info);
                        window.location.reload();
                    } else {
                        alert(reg.info);
                    }
                });
            });

            //图文添加按钮
            $("#itemAddButton").click(function () {
                showGuiZeDialog(0);
            });

        });

        //创建图文的窗口
        function showGuiZeDialog(id) {

            var rid = $("#hidId").val();
            var act = $("#lblreqestType").text();

            var contenturl = "";
            if (id == 0) {
                contenturl = "url:weixin/addNews.html?option=add&rid=" + rid + "&act=" + act;
            }
            else {
                contenturl = "url:weixin/addNews.html?option=edit&rid=" + rid + "&id=" + id + "&act=" + act;
            }
            var m = $.dialog({
                id: 'dialogGuiZe',
                fixed: true,
                lock: true,
                max: false,
                min: false,
                title: "添加回复规则",
                content: contenturl,
                height: 420,
                width: 750,

                close: function () {
                    this.reload();
                }
            });
        }

        //执行回传函数
        function Delete(id) {
            $.post("../../Ajax/wxrequestRulesManager.ashx?type=delete", { id: id }, function (msg) {
                var result = $.parseJSON(msg);
                if (msg && msg.status == "y") {
                    window.location.reload();
                }
            });
        }

    </script>

</body>
</html>
