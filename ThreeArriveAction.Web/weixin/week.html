<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width" />
    <meta name="viewport" content="initial-scale=1.0,user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="stylesheet" type="text/css" href="../css/css.css">
    <title>三到行动</title>
    <style>
        select {
            height: 30px;
            border: 1px solid #eeeeee;
            padding-left: 5px;
            width: 40%;
        }
    </style>
</head>
<body>
    <!--top开始-->
    <div class="banner">
        <img src="../images/banner_heiban.jpg">
    </div>
    <div class="header">
        <div class="crile">
        </div>
        <div class="text">
            每周家家到
        </div>
    </div>
    <div class="container">
        <div class="row">
            <div class="header">
                <div class="text">
                    照片
                </div>
            </div>
            <div style="text-align: left;" id="app">
                <image-template v-bind:local-ids="localIds" v-bind:is-more="false"></image-template>
            </div>
        </div>
        <div class="row">
            <div class="header">
                <div class="text">
                    选择拜访户
                </div>
            </div>
            <div style="text-align: center;">
                <select id="subtype" onchange="getsubfamily()">
                    <option value="-1">-请选择-</option>
                    <option value="1">留守老人户</option>
                    <option value="2">重大病户</option>
                    <option value="3">五保户</option>
                    <option value="4">低保户</option>
                    <option value="5">离任村干部户</option>
                    <option value="6">老党员户</option>
                    <option value="7">信访户</option>
                </select>
                <select id="subfamily"></select>
            </div>
        </div>
        <div class="row">
            <div class="header">
                <div class="text">
                    描述
                </div>
            </div>
            <div style="text-align: center;">
                <textarea id="thing" style="width: 100%; height: 100px;"></textarea>
            </div>
        </div>
        <div class="row">
            <div class="header">
                <div class="text">
                    结果
                </div>
            </div>
            <div style="text-align: center;">
                <textarea id="result" style="width: 100%; height: 100px;"></textarea>
            </div>
        </div>

        <div class="row">
            <input type="button" class="btn" value="提交" onclick="submit()" />
        </div>
    </div>
    <script src="../scripts/jquery/jquery-1.10.2.min.js" type="text/javascript"></script>
    <script src="../scripts/vue/vue.js"></script>
    <script src="../scripts/weixin/jweixin-1.2.0.js"></script>
    <script src="../scripts/weixin/js-sdk-config.js"></script>
    <script src="../scripts/weixin/imageTemplate.js"></script>
    <script>
        var vm = new Vue({
            el: "#app",
            data: {
                localIds: []
            },
        });

        function submit() {
            vm.localIds.forEach((localId) => {
                wx.uploadImage({
                    localId: localId.toString(),
                    isShowProgressTips: 1,
                    success: function (res) {
                        var serverId = res.serverId;
                        $.ajax({
                            url: "../Ajax/weixinInfo.ashx",
                            type: "post",
                            data: {
                                type: "downFile",
                                mediaId: serverId,
                                openId: localStorage.getItem("openId")
                            },
                            success: function (d) {
                                wx.getLocation({
                                    type: 'wgs84', // 默认为wgs84的gps坐标，如果要返回直接给openLocation用的火星坐标，可传入'gcj02'
                                    success: function (res) {
                                        $.ajax({
                                            url: "../Ajax/sys_WeekArrivesManager.ashx?type=add",
                                            type: "post",
                                            data: {
                                                opneId: localStorage.getItem("openId"),
                                                slSubId: subfamily.val(),
                                                ThingMessage: $("#thing").html(),
                                                ThingResult: $("#result").html(),
                                                txtImgUrl: d,
                                                xpoint: res.latitude,
                                                ypoint: res.longitude
                                            },
                                            success: function (d) {
                                                alert(JSON.parse(d).info);
                                            }, error: function (d) {
                                                console.log(d);
                                            }
                                        });
                                    }
                                });

                            }, error: function (d) {
                                console.log(d);
                            }
                        });
                    }
                });
            });
        }

        function getsubfamily() {
            var value = $("#subtype").val();
            $.ajax({
                url: "../Ajax/sys_SubscriberFamilyManager.ashx?type=getsubfamily",
                type: "post",
                data: {
                    value: value,
                    openId: localStorage.getItem("openId")
                },
                success: function (d) {
                    var obj = JSON.parse(d);
                    var html = "";
                    obj.forEach((o, i) => {
                        html += `<option ${i == 0 ? " selected" : ""} value="${o.key}">${o.value}</option>`;
                    });
                    $("#subfamily").html(html);
                }, error: function (d) {
                    console.log(d);
                }
            });
        }
    </script>
</body>
</html>
